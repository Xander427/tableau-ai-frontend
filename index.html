<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AI Data Assistant</title>

  <!-- Local extension API -->
  <script src="tableau.extensions.1.14.0.min.js"></script>

  <script>
  async function init() {
    try {
      await tableau.extensions.initializeAsync();
      console.log("âœ… Tableau Extension initialized. window.tableau:", !!window.tableau);

      // List worksheets for debugging
      const dashboard = tableau.extensions.dashboardContent.dashboard;
      console.log("Dashboard name:", dashboard.name);
      console.log("Worksheets available:", dashboard.worksheets.map(w => w.name));

      if (dashboard.worksheets.length) {
        const ws = dashboard.worksheets[0];
        console.log("First worksheet:", ws.name);

        try {
          const cols = await ws.getSummaryDataAsync({ maxRows: 1 });
          console.log("Sample summary columns:",
            cols.columns.map(c => ({ field: c.fieldName, dataType: c.dataType }))
          );
        } catch (e) {
          console.warn("Could not fetch summary data:", e);
        }
      }
    } catch (err) {
      console.error("Failed to initialize Tableau Extension:", err);
    }
  }

  async function getFilterValueObj(worksheet, fieldName, rawValue) {
    const summary = await worksheet.getSummaryDataAsync();
    
    // Find the column index
    const colIndex = summary.columns.findIndex(
      c => c.fieldName === fieldName
    );
    if (colIndex === -1) return null;

    // Search rows for a matching entry
    for (let row of summary.data) {
      const cell = row[colIndex];
      if (!cell) continue;

      if (cell.formattedValue === rawValue) {
        return cell;   // A real Tableau filter value object
      }
    }

    return null;
  }
  

  async function applyFiltersFromResponse(filtersObj) {
    if (!window.tableau) {
      console.warn("Tableau not detected; skipping filter apply.");
      return;
    }

    const dashboard = tableau.extensions.dashboardContent.dashboard;
    let targetWs = dashboard.worksheets.find(ws => ws.name === "Report Builder ");
    if (!targetWs) targetWs = dashboard.worksheets[0];

    // ðŸ” NEW: Log column names for this worksheet
    const summary = await targetWs.getSummaryDataAsync({ maxRows: 1 });
    console.log(`Summary columns for ${targetWs.name}:`,
      summary.columns.map(c => c.fieldName)
    );

    const filters = await targetWs.getFiltersAsync();
    console.log("Worksheet Filters:", filters.map(f => ({
      fieldName: f.fieldName,
      filterType: f.filterType
    })));

    const fieldName = "Platform"; // or Channel, etc.
    const fieldFilter = filters.find(f => f.fieldName === fieldName);
    console.log("Filter values for", fieldName, ":", fieldFilter.appliedValues?.map(v => v.formattedValue));

    // Apply filters
    for (const [fieldName, rawValues] of Object.entries(filtersObj)) {

      const tableauValues = [];

      for (const v of rawValues) {
        const obj = await getFilterValueObj(targetWs, fieldName, v);
        if (obj) tableauValues.push(obj);
      }

      if (tableauValues.length === 0) {
        console.warn("No matching Tableau values for", fieldName);
        continue;
      }

      await targetWs.applyFilterAsync(
        fieldName,
        tableauValues,
        tableau.FilterUpdateType.REPLACE
      );
    }

  }

  document.addEventListener("DOMContentLoaded", init);
  </script>

  <style>
    body {
      font-family: system-ui, sans-serif;
      background-color: #f5f6fa;
      margin: 0;
      padding: 15px;
    }
    #askButton {
      display: block;     /* makes it go to next line */
      margin-top: 10px;   /* spacing */
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      background: #2f7df6;
      color: white;
      font-weight: 500;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <h2>AI Data Assistant</h2>
  <p>Ask a question about your data:</p>
  <input id="question" placeholder="e.g., Show me Facebook spend by week" />
  <button id="askButton" onclick="askAI()">Ask</button>
  <div id="output"></div>

  <!-- ðŸ”¥ Missing askAI() â€” now added -->
  <script>
  async function askAI() {
    const question = document.getElementById("question").value.trim();
    const output = document.getElementById("output");

    if (!question) {
      output.innerText = "Please enter a question.";
      return;
    }

    output.innerHTML = "<em>Thinking...</em>";

    try {
      const response = await fetch(
        "https://ej-tableau-ai-api-c5gvdag0gdhrbnca.eastus-01.azurewebsites.net/ai_query",
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ query: question })
        }
      );

      if (!response.ok) throw new Error("API request failed");

      const data = await response.json();

      // Display results
      output.innerHTML = `
        <b>Summary:</b><br>${data.summary || "(no summary)"}<br><br>
        <b>Rows:</b><br><pre>${JSON.stringify(data.rows ?? [], null, 2)}</pre><br>
        <b>SQL:</b><br><pre>${data.sql ?? "(none)"}</pre>
      `;

      // Apply filters
      if (data.filters) {
        console.log("Applying filters:", data.filters);
        await applyFiltersFromResponse(data.filters);
      } else {
        console.log("No filters returned from AI.");
      }

    } catch (err) {
      console.error("askAI() error:", err);
      output.innerHTML = `<span style='color:red'>Error: ${err.message}</span>`;
    }
  }
  </script>
</body>
</html>
