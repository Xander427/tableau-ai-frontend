<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AI Data Assistant</title>
  <script src="https://cdn.tableau.com/extensions-api/latest/tableau.extensions.latest.min.js"></script>
  <script>
  async function init() {
    try {
      await tableau.extensions.initializeAsync();
      console.log("✅ Tableau Extension initialized. window.tableau:", !!window.tableau);

      // List worksheets & fields for debugging
      const dashboard = tableau.extensions.dashboardContent.dashboard;
      console.log("Dashboard name:", dashboard.name);
      console.log("Worksheets available:", dashboard.worksheets.map(w => w.name));

      // Print columns/columns metadata for first worksheet (if any)
      if (dashboard.worksheets.length) {
        const ws = dashboard.worksheets[0];
        console.log("First worksheet:", ws.name);
        try {
          const cols = await ws.getSummaryDataAsync({ maxRows: 1 });
          console.log("Sample summary columns:", cols.columns.map(c => ({ field: c.fieldName, dataType: c.dataType })));
        } catch (e) {
          console.warn("Could not fetch summary data for sample columns (maybe permissions):", e);
        }
      }

    } catch (err) {
      console.error("Failed to initialize Tableau Extension:", err);
    }
  }

  // Apply filters helper used by askAI() after response arrives
  async function applyFiltersFromResponse(filtersObj) {
    if (!window.tableau) {
      console.warn("Tableau object not detected; skipping filter apply.");
      return;
    }
    const dashboard = tableau.extensions.dashboardContent.dashboard;
    console.log("Attempting to apply filters. Worksheets:", dashboard.worksheets.map(w=>w.name));

    for (const [field, values] of Object.entries(filtersObj)) {
      // try find a worksheet that contains this field (or just pick a specific sheet name)
      let targetWs = dashboard.worksheets.find(ws => ws.name === "Report Builder ");
      if (!targetWs) {
        // fallback: first worksheet
        targetWs = dashboard.worksheets[0];
      }
      if (!targetWs) {
        console.warn("No worksheet available to apply filter:", field);
        continue;
      }

      try {
        console.log(`Applying filter ${field} =>`, values, "to worksheet", targetWs.name);
        await targetWs.applyFilterAsync(field, values, tableau.FilterUpdateType.REPLACE);
        console.log(`✅ Applied filter ${field} on ${targetWs.name}`);
      } catch (err) {
        console.error(`Failed to apply filter ${field} on ${targetWs.name}:`, err);
      }
    }
  }

  document.addEventListener("DOMContentLoaded", init);
</script>

  <style>
    body {
      font-family: system-ui, sans-serif;
      background-color: #f5f6fa;
      margin: 0;
      padding: 15px;
    }
    h2 {
      margin-top: 0;
    }
    #question {
      width: 100%;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    #askButton {
      margin-top: 10px;
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      background: #2f7df6;
      color: white;
      font-weight: 500;
      cursor: pointer;
    }
    #askButton:hover {
      background: #1e5fd1;
    }
    #output {
      margin-top: 15px;
      padding: 10px;
      background: #fff;
      border-radius: 8px;
      border: 1px solid #ddd;
      font-size: 14px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
  </style>
</head>

<body>
  <h2>AI Data Assistant</h2>
  <p>Ask a question about your data:</p>
  <input id="question" placeholder="e.g., Show me Facebook spend by week" />
  <button id="askButton" onclick="askAI()">Ask</button>
  <div id="output"></div>
</body>
</html>
